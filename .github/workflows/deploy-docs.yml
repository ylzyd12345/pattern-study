name: Deploy Documentation

on:
  push:
    branches: [ main ]
    paths: [ 'docs/**', 'README.md', 'CHANGELOG.md', 'FAQ.md', '**.md' ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Setup Pages
      uses: actions/configure-pages@v4
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    - name: Build with Maven
      run: mvn clean compile javadoc:javadoc -B
    - name: Copy documentation
      run: |
        mkdir -p _site
        cp README.md _site/index.md
        cp FAQ.md _site/faq.md
        cp CHANGELOG.md _site/changelog.md
        cp -r docs/* _site/
        cp -r target/site/apidocs _site/javadoc/
        
        # Create _config.yml for Jekyll
        echo 'title: "è®¾è®¡æ¨¡å¼å­¦ä¹ é¡¹ç›®"' > _site/_config.yml
        echo 'description: "23ç§Javaè®¾è®¡æ¨¡å¼çš„å®Œæ•´å®žçŽ°å’Œè¯¦ç»†è¯´æ˜Ž"' >> _site/_config.yml
        echo 'theme: jekyll-theme-cayman' >> _site/_config.yml
        echo 'markdown: kramdown' >> _site/_config.yml
        echo 'highlighter: rouge' >> _site/_config.yml
        echo 'plugins:' >> _site/_config.yml
        echo '  - jekyll-sitemap' >> _site/_config.yml
        echo '  - jekyll-feed' >> _site/_config.yml
        
        # Create index.html for Jekyll
        echo '---' > _site/index.html
        echo 'layout: default' >> _site/index.html
        echo 'title: è®¾è®¡æ¨¡å¼å­¦ä¹ é¡¹ç›®' >> _site/index.html
        echo '---' >> _site/index.html
        echo '' >> _site/index.html
        echo '# è®¾è®¡æ¨¡å¼å­¦ä¹ é¡¹ç›®' >> _site/index.html
        echo '' >> _site/index.html
        echo 'æ¬¢è¿Žè®¿é—®è®¾è®¡æ¨¡å¼å­¦ä¹ é¡¹ç›®çš„å®Œæ•´æ–‡æ¡£ï¼' >> _site/index.html
        echo '' >> _site/index.html
        echo '## ðŸ“š å¿«é€Ÿå¯¼èˆª' >> _site/index.html
        echo '' >> _site/index.html
        echo '- [ðŸ“– é¡¹ç›®é¦–é¡µ](index.md)' >> _site/index.html
        echo '- [â“ å¸¸è§é—®é¢˜](faq.md)' >> _site/index.html
        echo '- [ðŸ“ æ›´æ–°æ—¥å¿—](changelog.md)' >> _site/index.html
        echo '- [ðŸŒ³ è®¾è®¡æ¨¡å¼å†³ç­–æ ‘](design-pattern-decision-tree.md)' >> _site/index.html
        echo '- [ðŸ“Š æ€§èƒ½å¯¹æ¯”åˆ†æž](performance-comparison.md)' >> _site/index.html
        echo '- [ðŸ’» ä»£ç ç¤ºä¾‹å¯¼èˆª](code-examples.md)' >> _site/index.html
        echo '' >> _site/index.html
        echo '## ðŸ—ï¸ è®¾è®¡æ¨¡å¼åˆ†ç±»' >> _site/index.html
        echo '' >> _site/index.html
        echo '### åˆ›å»ºåž‹æ¨¡å¼' >> _site/index.html
        echo '- [å•ä¾‹æ¨¡å¼](creational/å•ä¾‹/singleton-pattern.md)' >> _site/index.html
        echo '- [å·¥åŽ‚æ–¹æ³•](creational/å·¥åŽ‚/factory-method-pattern.md)' >> _site/index.html
        echo '- [æŠ½è±¡å·¥åŽ‚](creational/æŠ½è±¡å·¥åŽ‚/abstract-factory-pattern.md)' >> _site/index.html
        echo '- [å»ºé€ è€…æ¨¡å¼](creational/å»ºé€ è€…/builder-pattern.md)' >> _site/index.html
        echo '- [åŽŸåž‹æ¨¡å¼](creational/åŽŸ/prototype-pattern.md)' >> _site/index.html
        echo '' >> _site/index.html
        echo '### ç»“æž„åž‹æ¨¡å¼' >> _site/index.html
        echo '- [é€‚é…å™¨æ¨¡å¼](structural/é€‚é…/adapter-pattern.md)' >> _site/index.html
        echo '- [æ¡¥æŽ¥æ¨¡å¼](structural/æ¡¥/bridge-pattern.md)' >> _site/index.html
        echo '- [ç»„åˆæ¨¡å¼](structural/ç»„åˆ/composite-pattern.md)' >> _site/index.html
        echo '- [è£…é¥°å™¨æ¨¡å¼](structural/è£…é¥°/decorator-pattern.md)' >> _site/index.html
        echo '- [å¤–è§‚æ¨¡å¼](structural/å¤–è§‚/facade-pattern.md)' >> _site/index.html
        echo '- [äº«å…ƒæ¨¡å¼](structural/äº«å…ƒ/flyweight-pattern.md)' >> _site/index.html
        echo '- [ä»£ç†æ¨¡å¼](structural/ä»£ç†/proxy-pattern.md)' >> _site/index.html
        echo '' >> _site/index.html
        echo '### è¡Œä¸ºåž‹æ¨¡å¼' >> _site/index.html
        echo '- [è´£ä»»é“¾æ¨¡å¼](behavioral/è´£ä»»é“¾/chain-of-responsibility-pattern.md)' >> _site/index.html
        echo '- [å‘½ä»¤æ¨¡å¼](behavioral/å‘½ä»¤/command-pattern.md)' >> _site/index.html
        echo '- [è§£é‡Šå™¨æ¨¡å¼](behavioral/è§£é‡Š/interpreter-pattern.md)' >> _site/index.html
        echo '- [è¿­ä»£å™¨æ¨¡å¼](behavioral/è¿­ä»£/iterator-pattern.md)' >> _site/index.html
        echo '- [ä¸­ä»‹è€…æ¨¡å¼](behavioral/ä¸­ä»‹/mediator-pattern.md)' >> _site/index.html
        echo '- [å¤‡å¿˜å½•æ¨¡å¼](behavioral/å¤‡å¿˜å½•/memento-pattern.md)' >> _site/index.html
        echo '- [è§‚å¯Ÿè€…æ¨¡å¼](behavioral/è§‚å¯Ÿè€…/observer-pattern.md)' >> _site/index.html
        echo '- [çŠ¶æ€æ¨¡å¼](behavioral/çŠ¶æ€/state-pattern.md)' >> _site/index.html
        echo '- [ç­–ç•¥æ¨¡å¼](behavioral/ç­–ç•¥/strategy-pattern.md)' >> _site/index.html
        echo '- [æ¨¡æ¿æ–¹æ³•æ¨¡å¼](behavioral/æ¨¡æ¿/template-method-pattern.md)' >> _site/index.html
        echo '- [è®¿é—®è€…æ¨¡å¼](behavioral/è®¿é—®è€…/visitor-pattern.md)' >> _site/index.html
        echo '' >> _site/index.html
        echo '## ðŸ”— é“¾æŽ¥' >> _site/index.html
        echo '' >> _site/index.html
        echo '- [GitHubä»“åº“](https://github.com/ylzyd12345/pattern-study)' >> _site/index.html
        echo '- [é—®é¢˜åé¦ˆ](https://github.com/ylzyd12345/pattern-study/issues)' >> _site/index.html
        echo '- [è®¨è®ºåŒº](https://github.com/ylzyd12345/pattern-study/discussions)' >> _site/index.html
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v4
      with:
        path: './_site'

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4